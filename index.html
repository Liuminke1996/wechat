<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <title>Document</title>
</head>
<body>
  <button onclick="wxlogin.login()">登录1111</button>
</body>
<script>
  let wxlogin = {
    config:{
      appId:'wx2a18e3dc23043171',
      redirect_uri:encodeURI('https://liuminke1996.github.io/wechat/index.html'),
      appsecret:'4e0f2fbad2e0ccc4f8d9dad86092b857'
    },
    login(){
      const config = this.config;
      window.location.href = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${config.appId}&redirect_uri=${config.redirect_uri}&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect`
    },
    getQuery(name){
      var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
      var r = window.location.search.substr(1).match(reg);
      return r != null? unescape(r[2]):null
    },
    getCode(){
      let code = this.getQuery('code')
      if(code){
        this.getAccessToken(code)
      }
    },
    getAccessToken(code){
      const config = this.config;
      axios.jsonp(`https://api.weixin.qq.com/sns/oauth2/access_token?appid=${config.appId}&secret=${config.appsecret}&code=${code}&grant_type=authorization_code`)
      .then(function (res) {
        alert(JSON.stringify(res));
      }).catch(function (error) {
        alert(JSON.stringify(error)+'error');
      });
      
    }
  }
  wxlogin.getCode();
  //axios本版本不支持jsonp 自己拓展一个
axios.jsonp = function(url){
  if(!url){
      console.error('Axios.JSONP 至少需要一个url参数!')
      return;
  }
  return new Promise((resolve,reject) => {
    window.jsonCallBack =(result) => {
        resolve(result)
    }
    var JSONP=document.createElement("script");
    JSONP.type="text/javascript";
    JSONP.src=`${url}&callback=jsonCallBack`;
    document.getElementsByTagName("head")[0].appendChild(JSONP);
    setTimeout(() => {
        document.getElementsByTagName("head")[0].removeChild(JSONP)
    },500)
  })
}
</script>
</html>